"use strict";require("../shelljs/make");var fs=require("fs"),path=require("path"),vm=require("vm");function preprocess(l,q,r){var c=fs.readFileSync(l).toString().split("\n");var k=c.length;var u="";var t=0;function o(){if(t<k){return c[t++]}return null}var d=(typeof q==="function"?q:function(e){u+=e+"\n"});function a(i){var m=fs.realpathSync(l);var e=path.dirname(m);preprocess(path.join(e,i),d,r)}function b(e){e=e.replace(/__[\w]+__/g,function(i){i=i.substring(2,i.length-2);if(i in r){return r[i]}return""});d(e)}var j,f=0,g=[];var h=/^(?:\/\/|<!--)\s*#(if|else|endif|expand|include)(?:\s+(.*?)(?:-->)?$)?/;var n=0;while((j=o())!==null){++n;var p=h.exec(j);if(p){switch(p[1]){case"if":g.push(f);try{f=vm.runInNewContext(p[2],r)?3:1}catch(v){console.error("Could not evalute line '"+p[2]+"' at "+fs.realpathSync(l)+":"+n);throw v}break;case"else":f=f===1?3:2;break;case"endif":f=g.pop();break;case"expand":if(f===0||f===3){b(p[2])}break;case"include":if(f===0||f===3){a(p[2])}break}}else{if(f===0){d(j)}else{if(f===3){d(j.replace(/^\/\/|^<!--|-->/g,"  "))}}}}if(f!==0||g.length!==0){throw new Error("Missing endif in preprocessor.")}if(typeof q!=="function"){fs.writeFileSync(q,u)}}exports.preprocess=preprocess;var deprecatedInMozcentral=new RegExp("(^|\\W)("+["-moz-box-sizing","-moz-grab","-moz-grabbing"].join("|")+")");function preprocessCSS(h,f,a){function e(i){return(/(^|\W)-(ms|o|webkit)-\w/.test(i))}function b(i){return(/(^|\W)-(ms|o|webkit)-\w/.test(i)||deprecatedInMozcentral.test(i))}function g(o,r){var l=o.split(/\r?\n/g);var n=0;while(n<l.length){var k=l[n];if(!r(k)){n++;continue}if(/\{\s*$/.test(k)){var p=1;var m=n+1;while(m<l.length&&p>0){var q=/([{}])\s*$/.exec(l[m]);if(q){if(q[1]==="{"){p++}else{if(l[m].indexOf("{")<0){p--}}}m++}l.splice(n,m-n)}else{if(/[};]\s*$/.test(k)){l.splice(n,1)}else{do{l.splice(n,1)}while(n<l.length&&!/\}\s*$/.test(l[n])&&l[n].indexOf(":")<0);if(n<l.length&&/\S\s*}\s*$/.test(l[n])){l[n]=l[n].substr(l[n].indexOf("}"))}}}while(l[n]===""&&l[n-1]===""){l.splice(n,1)}}return l.join("\n")}if(h!=="firefox"&&h!=="mozcentral"){throw new Error("Invalid CSS preprocessor mode")}var d=fs.readFileSync(f,"utf8");var c=g(d,h==="mozcentral"?b:e);fs.writeFileSync(a,c)}exports.preprocessCSS=preprocessCSS;function build(a){var b=a.defines;a.copy.forEach(function(d){var e=d[0];var c=d[1];cp("-R",e,c)});a.preprocess.forEach(function(e){var d=e[0];var c=e[1];d=ls("-R",d);d.forEach(function(f){var g=c;if(test("-d",c)){g+="/"+path.basename(f)}preprocess(f,g,b)})});(a.preprocessCSS||[]).forEach(function(d){var f=d[0];var e=d[1];var c=d[2];preprocessCSS(f,e,c)})}exports.build=build;function merge(d,c){var a={};for(var b in d){a[b]=d[b]}for(b in c){a[b]=c[b]}return a}exports.merge=merge;