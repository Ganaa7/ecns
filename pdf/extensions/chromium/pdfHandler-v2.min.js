(function(){if(!chrome.streamsPrivate){console.warn("streamsPrivate not available, PDF from FTP or POST requests will not be displayed using this extension! See http://crbug.com/326949");chrome.runtime.onMessage.addListener(function(n,m,l){if(n&&n.action==="getPDFStream"){l()}});return}var a={};chrome.streamsPrivate.onExecuteMimeTypeHandler.addListener(g);var h=true;var b=0;function k(l,m){var n=a[h?l:b];return(n&&n[m]&&n[m].length>0)}function f(l,n){if(!h){l=b}if(k(l,n)){var m=a[l][n].shift();if(a[l][n].length===0){delete a[l][n];if(Object.keys(a[l]).length===0){delete a[l]}}return m}}function i(n,o,l,m){n=n||b;if(!a[n]){a[n]={}}if(!a[n][o]){a[n][o]=[]}a[n][o].push({streamUrl:l,contentLength:m})}function j(m,o){if(chrome.extension.inIncognitoContext){console.log("Already within incognito profile. Aborted stream transfer.");return}var n=f(m,o);if(!n){return}console.log("Attempting to transfer stream info to a different profile...");var p="streamInfo:"+window.performance.now();var l={};l[p]={tabId:m,pdfUrl:o,streamUrl:n.streamUrl,contentLength:n.contentLength};chrome.storage.local.set(l,function(){chrome.extension.isAllowedIncognitoAccess(function(q){if(!q){console.warn("Incognito is disabled, unexpected unknown stream.");chrome.storage.local.remove(l)}})})}if(chrome.extension.inIncognitoContext){var c=function(m,l){if(m.lastIndexOf("streamInfo:",0)!==0){return}console.log("Importing stream info from non-incognito profile",l);g("",l.pdfUrl,l.streamUrl,l.tabId,l.contentLength);chrome.storage.local.remove(m)};var d=function(l){Object.keys(l).forEach(function(n){var m=l[n];if(m.oldValue&&!m.newValue){return}if(m.newValue){m=m.newValue}c(n,m)})};chrome.storage.local.get(null,d);chrome.storage.onChanged.addListener(d)}chrome.runtime.onMessage.addListener(function(n,m,l){if(n&&n.action==="getPDFStream"){var p=n.data;var o=f(m.tab.id,p)||{};l({streamUrl:o.streamUrl,contentLength:o.contentLength})}});function g(p,o,l,n,m){console.log("Intercepted "+p+" in tab "+n+" with URL "+o+"\nAvailable as: "+l);h=typeof n==="number";i(n,o,l,m);if(!n){return}chrome.webNavigation.getAllFrames({tabId:n},function(q){if(q){q=q.filter(function(r){return(r.url===o)});if(q.length>0){if(q.length!==1){console.warn("More than one frame found for tabId "+n+" with URL "+o+". Using first frame.")}q=q[0];q={tabId:n,frameId:q.frameId,url:q.url};e(q)}else{console.warn("No webNavigation frames found for tabId "+n)}}else{console.warn("Unable to get frame information for tabId "+n);j(n,o)}})}function e(n){var l=n.tabId;var o=n.frameId;var p=n.url;if(!k(l,p)){console.log("No PDF stream found in tab "+l+" for "+p);return}var m=getViewerURL(p);if(o===0){console.log("Going to render PDF Viewer in main frame for "+p);chrome.tabs.update(l,{url:m})}else{console.log("Going to render PDF Viewer in sub frame for "+p);chrome.tabs.executeScriptInFrame(l,{frameId:o,code:"location.href = "+JSON.stringify(m)+";"},function(q){if(!q){console.warn("Frame not found, viewer not rendered in tab "+l)}})}}})();