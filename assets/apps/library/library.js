function upload_file(e){var i=new FormData($(e)[0]);$.ajax({url:base_url+"/library/index/upload/",type:"POST",data:i,processData:!1,contentType:!1,success:function(i){console.log("json"+JSON.stringify(i)),"success"==i.status?(console.log("selector none"),$("input[name=ebook]").val(i.name),$("input[type='file",e).val("").hide(),$("#_file",e).lenght||$("#_file",e).append("<span id='file_link'><a target=_blank href='"+base_url+"/download/library_files/"+i.name+"' style='color:blue'>"+i.name+"</a> (<a href='#' style='color:red' onclick='javascript:del_file(\""+i.name+'", "'+e.selector+"\")'>Устгах</a>)</span>"),feeds("success",i.name+" нэртэй файлыг амжилттай байршууллаа!")):(feeds("error",i.message),$("input[type='file",e,edit).val(""))}})}function jqgrid(){$("#grid").jqGrid({url:base_url+"/library/index/grid",datatype:"json",mtype:"GET",colNames:["№","Хэсэг","Төхөөрөмж","Гарчиг","Зохиогч","Хэвлэсэн он","ISBN"],colModel:[{name:"spare_id",index:"spare_id",width:15,align:"center"},{name:"section",index:"section.section",width:50,align:"center",stype:"select",searchoptions:{value:set_section()},formatter:view_link},{name:"equipment",index:"equipment.equipment",width:120,formatter:view_link},{name:"title",index:"title",width:80,align:"center",formatter:view_link},{name:"author",index:"author",width:60,align:"center",formatter:view_link},{name:"year_of_pub",index:"year_of_pub",width:50,align:"center"},{name:"isbn",index:"isbn",width:50,align:"center"}],jsonReader:{page:"page",total:"total",records:"records",root:"rows",repeatitems:!1,id:"id"},pager:"#pager",rowNum:20,rowList:[10,20,30,40,60,80,100],sortname:"id",sortorder:"asc",viewrecords:!0,gridview:!0,caption:"Номын сангийн бүртгэл",autowidth:!0,height:500,width:"100%",loadComplete:function(){for(var e=$(this).jqGrid("getDataIDs"),i=0;i<e.length;i++){$("#grid").jqGrid("getRowData",e[i]);jQuery("#"+e[i],jQuery("#grid")).addClass("context-menu")}},subGrid:!1}).navGrid("#pager",{edit:!1,add:!1,del:!1,search:!0}),jQuery("#grid").jqGrid("filterToolbar",{searchOperators:!0,stringResult:!0,defaultSearch:"cn"})}function set_section(){var e="",i=0;return $("#section_id option").each(function(){e=$(this).text()+":"+$(this).text(),i++}),console.log("count"+i),e=":Бүгд;Холбоо:Холбоо;Навигаци:Навигаци;Ажиглалт:Ажиглалт;Гэрэл суулт, цахилгаан:ГСЦ"}function add_modal(){add.dialog({buttons:{"Хадгалах":function(){var e=$("#create").serialize();$.ajax({type:"POST",url:base_url+"/library/index/add",data:e,dataType:"json",async:!1,success:function(e){"success"==e.status?(add.dialog("close"),showMessage(e.message,"success"),jQuery("#grid").jqGrid("setGridParam",{datatype:"json"}).trigger("reloadGrid")):$("p.feedback",add).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){add.dialog("close")}}}),add.dialog("open")}function edit_modal(e,i){$("input[name=id]",edit).val(e),$.ajax({type:"POST",url:base_url+"/library/index/get/",data:{id:e},dataType:"json",success:function(e){$("#id",edit).val(e.id),$("#section_id option[value="+e.section_id+"]",edit).attr("selected","selected"),$("#equipment_id option[value="+e.equipment_id+"]",edit).attr("selected","selected"),$("#title",edit).val(e.title),$("#author",edit).val(e.author),$("#year_of_pub",edit).val(e.year_of_pub),$("#isbn",edit).val(e.isbn),e.ebook?($("#ebook",edit).val(e.ebook),$("#userfile",edit).hide(),$("#_file",edit).append("<span id='file_link'><a style='color:blue;' href='"+base_url+"/download/library_files/"+e.ebook+"'>"+e.ebook+"</a> (<a href='#' style='color:red' onclick='del_file(\""+e.ebook+'", "'+edit.selector+"\")'> Устгах </a>)</span>")):edit.is(":hidden")&&$("#userfile",edit).show()}}).done(function(){edit.dialog({title:"Засах: "+i,buttons:{"Хадгалах":function(){var e=$("#edit").serialize();$.ajax({type:"POST",url:base_url+"/library/index/edit",data:e,dataType:"json",async:!1,success:function(e){"success"==e.status?(edit.dialog("close"),showMessage(e.message,"success"),jQuery("#grid").jqGrid("setGridParam",{datatype:"json"}).trigger("reloadGrid")):$("p.feedback",add).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){edit.dialog("close")}}}),edit.dialog("open")})}function feeds(e,i){$("p.feedback").hasClass("error")&&$("p.feedback").removeClass("error"),$("p.feedback").hasClass("success")&&$("p.feedback").removeClass("success"),$("p.feedback").addClass(e).html(i).fadeIn("slow").delay(5e3).fadeOut()}function del_file(e,i){console.log("selector"+i);var t;if(t="#edit"==i?{file_name:e,id:$("input[name=id]",i).val(),form:i}:{file_name:e,form:i},1!=confirm("["+e+"] энэ файлыг устгахдаа итгэлтэй байна уу?"))return 0;$.ajax({type:"POST",url:base_url+"/library/index/del_file/"+e,data:t,dataType:"json",success:function(e){e.success?(feeds("success",e.message),$("#userfile",i).show(),$("#file_link",i).remove()):(feeds("error",e.message),$("#userfile",i).show(),$("#file_link",i).remove())}})}function help_modal(){$("#dialog").dialog({buttons:{"Хаах":function(){$(this).dialog("close")}}}),$("#dialog").dialog("open")}function view_link(e,i,t){return"<a target='_blank' href='"+base_url+"/download/library_files/"+t.ebook+"' >"+e+"</a>"}function filter(e,i,t){$.post(base_url+"/library/index/filter",{id:i},function(i){var a=$("#"+t+"_id",e);if(a.prop)o=a.prop("options");else var o=a.attr("options");$("option",a).remove(),$.each(i,function(e,i){o[o.length]=new Option(e,i)})})}var add,edit;$(function(){$("#dialog").dialog({autoOpen:!1,width:600,resizable:!1,modal:!0,close:function(){$(this).dialog("close")}}),$("#add_date").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),$("#need_date").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),jqgrid(),(add=$("#create")).dialog({autoOpen:!1,width:600,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea, input[type="file"]',$(this)).val(""),$(this).dialog("close")}}),(edit=$("#edit")).dialog({autoOpen:!1,width:600,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea, input[type="file"]',$(this)).val(""),$("#file_link",$(this)).remove(),$(this).dialog("close")}}),$("#userfile",add).change(function(){upload_file(add)}),$("#userfile",edit).change(function(){upload_file(edit)}),$("#section_id","#create").change(function(){filter("#create",$(this).val(),"equipment")}),$("#section_id","#edit").change(function(){filter("#edit",$(this).val(),"equipment")})});	