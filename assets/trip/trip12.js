function jqgrid(){$("#grid").jqGrid({url:base_url+"/trip/index/grid",datatype:"json",mtype:"GET",colNames:["№","Хэсэг","ИТА","Чиглэл","Зорилго","Т/хэрэгсэл","Нийт зай","Эхлэх/t","Дуусах/t","is_come"],colModel:[{name:"trip_no",index:"trip_no",width:15,align:"center"},{name:"section",index:"trip_section.section",width:50,align:"center",stype:"select",searchoptions:{value:set_section()}},{name:"employee",index:"employee",width:120},{name:"location",index:"location",width:80,align:"center"},{name:"purpose",index:"purpose",width:50,align:"center"},{name:"transport",index:"transport",width:40,align:"center"},{name:"distance",index:"distance",width:40,align:"center"},{name:"start_dt",index:"start_dt",width:60,align:"center",searchoptions:{sopt:["eq","ne","le","lt","gt","ge"],dataInit:function(e){$(e).datepicker({dateFormat:"yy-mm-dd"}).change(function(){$("#grid")[0].triggerToolbar()})}}},{name:"end_dt",index:"end_dt",width:60,align:"center",searchoptions:{sopt:["eq","ne","le","lt","gt","ge"],dataInit:function(e){$(e).datepicker({dateFormat:"yy-mm-dd"}).change(function(){$("#grid")[0].triggerToolbar()})}}},{name:"est_dt",index:"est_dt",hidden:!0,viewable:!0}],jsonReader:{page:"page",total:"total",records:"records",root:"rows",repeatitems:!1,id:"id"},pager:"#pager",rowNum:20,rowList:[10,20,30,40],sortname:"id",sortorder:"asc",viewrecords:!0,gridview:!0,caption:"Албан томилолтын бүртгэл",autowidth:!0,height:500,width:"100%",editurl:"server.php",loadComplete:function(){for(var e=$(this).jqGrid("getDataIDs"),t=0;t<e.length;t++){var o=$("#grid").jqGrid("getRowData",e[t]),a=jQuery("#"+e[t],jQuery("#grid"));check_hours(o.est_dt)>0&&(a.removeClass("ui-widget-content"),a.addClass("argent")),a.addClass("context-menu")}},subGrid:!0,subGridRowExpanded:function(e,t){var o;o="_"+e,jQuery("#"+e).html("<table id='"+o+"' class='scroll'></table>"),jQuery("#"+o).jqGrid({autoencode:!1,url:base_url+"/trip/index/sub_grid?id="+t,datatype:"xml",colNames:["#","Чиглэл","Гарах","Очих","Замын урт","Гарах цаг","Очих цаг","Is_come","Мэдээ өгсөн","Тэмдэглэл"],colModel:[{name:"route_id",index:"route_id",width:80,key:!0,hidden:!0,viewable:!0},{name:"num",index:"num",width:80,key:!0,align:"center"},{name:"from_route",index:"from_route",width:150,align:"center"},{name:"to_route",index:"to_route",width:150,align:"center"},{name:"distance",index:"distance",width:100,align:"center"},{name:"out_dt",index:"out_dt",width:100,align:"left"},{name:"est_dt",index:"est_dt",width:100,align:"left"},{name:"is_come",index:"is_come",hidden:!0,viewable:!0},{name:"infoby",index:"infoby",width:120,align:"center"},{name:"comment",index:"comment",width:200}],height:"100%",width:"100%",rowNum:20,sortname:"num",sortorder:"asc",loadComplete:function(){for(var e=$(this).jqGrid("getDataIDs"),t=0;t<e.length;t++){var o=jQuery("#"+e[t],jQuery("#grid")),a=$(this).jqGrid("getRowData",e[t]);(o=jQuery("#"+e[t],jQuery("#grid"))).addClass("context-menu-sub"),check_hours(a.est_dt)>0&&"Y"!==a.is_come&&(o.removeClass("ui-widget-content"),o.addClass("argent")),$(this).expandSubGridRow(e[t])}}})}}).navGrid("#pager",{edit:!1,add:!1,del:!1,search:!0}),jQuery("#grid").jqGrid("filterToolbar",{searchOperators:!0,stringResult:!0})}function set_section(){var e="",t=0;return $("#section_id option").each(function(){e=$(this).text()+":"+$(this).text(),t++}),console.log("count"+t),e=":Бүгд;Холбоо:Холбоо;Навигаци:Навигаци;Ажиглалт:Ажиглалт;Гэрэл суулт, цахилгаан:ГСЦ"}function init_edit(e){var t,o,a;$("#wrapper-tag",edit).append("<span class='btn-tag' id='tag_21'>Улаанбаатар </span><span>-></span>"),$(edit).append("<input type='hidden' name='route_id[]' id='route_id' class='route' value='21'> "),$(".route",edit).first().val(21),$.ajax({type:"POST",url:base_url+"/trip/index/get/",data:{id:e},dataType:"json",success:function(e){t=e.json.dtl,o=e.json.section,a=e.json.route,$("#trip_id",edit).val(e.json.id),$("#trip_no",edit).val(e.json.trip_no),$("#section_id option[value="+e.json.section_id+"]",edit).attr("selected","selected"),$("#location_id",edit).val(e.json.location_id),$("#purpose",edit).val(e.json.purpose),$("#transport",edit).val(e.json.transport),$("#start_dt_edit",edit).val(e.json.start_dt),$("#end_dt_edit",edit).val(e.json.end_dt),$.each(o,function(e,t){$("#section_id option[value="+e+"]",edit).attr("selected","selected")}),$("#section_id",edit).trigger("chosen:updated")}}).done(function(){$.post(base_url+"/trip/index/filter",{id:0},function(e){var t=$("#employee_id_edit",edit);if(t.prop)o=t.prop("options");else var o=t.attr("options");$("option",t).remove(),$.each(e,function(e,t){o[o.length]=new Option(t,e)})}).done(function(){$.each(t,function(e,t){$("#employee_id_edit option[value="+e+"]",edit).attr("selected","selected")}),$("#employee_id_edit").multiselect(),$(".available").css("width","240px"),$(".selected").css("width","200px")}),$.each(a,function(e,t){$("#wrapper-tag","#edit-form").append("<span class ='btn-tag' id='"+t+"'>"+$("#location option[value="+t+"]",edit).text()+" <a class='close-tag'><span class='text-icon'>×</span></a></span>"),$("#edit-form").append("<input type='hidden' name='route_id[]' class='route' value='"+t+"'>"),"Улаанбаатар"!==$("#location option[value="+t+"]",edit).text()&&$("#wrapper-tag","#edit-form").append("<span>-></span>")}),edit_dialog()})}function edit_dialog(){edit.dialog({buttons:{"Хадгалах":function(){if(1==confirm("Хэрэв энэ томилолтын маршрутыг өөрчилсөн тохиолдолд хасагдсан маршрут дээрх ирсэн, очсон мэдээлэл устгагдах болно гэдгийг анхаарна уу! Засахдаа итгэлтэй байна уу?")){$("p.feedback",edit).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var e={};$('input[type="text"], input[type="hidden"], select',edit).each(function(){var t=$(this);e[t.attr("name")]=t.val()}),e.routes=set_route("edit"),$.ajax({type:"POST",url:base_url+"/trip/index/edit/",data:e,dataType:"json",async:!1,success:function(e){"success"==e.status?(edit.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",edit).removeClass("success, notify").addClass("error").html(e.message).show()}})}},"Хаах":function(){edit.dialog("close")}}}),edit.dialog("open")}function init_spot(e,t){var o,a,s,i={id:e,parent_id:t};$.ajax({type:"POST",url:base_url+"/trip/index/get_route/",data:i,dataType:"json",success:function(e){o=e.status,"true"==e.status?($("#from_route","#in-form").val(e.json.from_route),$("#to_route","#in-form").val(e.json.to_route),$("#distance","#in-form").val(e.json.distance),$("#out_dt","#in-form").val(e.json.out_dt),$("#est_dt_","#in-form").val(e.json.est_dt),s=e.json.out_dt,a=e.json.is_come):(s=null,a="N"),gen_option(e,"#in-form")}}).done(function(){"true"==o&&s&&"N"==a?spot_dialog(e,t):"false"==o?alert("Өмнөх чиглэл явж буй ИТА-г очоогүй байхад дараагийн чиглэлд гарсан цагийг өгөх боломжгүй!"):null==s?alert('"Гарсан" эсэхийг тэмдэглээгүй тохиолдолд "Очсон" тэмдэглэх боломжгүй'):"true"==o&&"Y"==a&&alert("Энэ чиглэлд аль хэдийн очсон тул дахин тэмдэглэх шаардлаггүй!")})}function spot_dialog(e,t){spot.dialog({buttons:{"Хадгалах":function(){$("p.feedback",spot).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var o={route_id:e,parent_id:t};$('input[type="text"], input[type="hidden"], select',spot).each(function(){var e=$(this);o[e.attr("name")]=e.val()}),$.ajax({type:"POST",url:base_url+"/trip/index/update_route/",data:o,dataType:"json",success:function(e){"success"==e.status?(spot.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",spot).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){spot.dialog("close")}}}),spot.dialog("open")}function go_dialog(e,t){go.dialog({buttons:{"Хадгалах":function(){$("p.feedback",go).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var o={};$('input[type="text"], input[type="hidden"], select',go).each(function(){var e=$(this);o[e.attr("name")]=e.val()}),o.route_id=e,o.parent_id=t,$.ajax({type:"POST",url:base_url+"/trip/index/update_route/",data:o,dataType:"json",success:function(e){"success"==e.status?(go.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",go).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){go.dialog("close")}}}),go.dialog("open")}function comment_dialog(e,t){var o,a={id:e,parent_id:t};$.ajax({type:"POST",url:base_url+"/trip/index/get_route/",async:!1,data:a,dataType:"json",success:function(e){"false"==e.status?o=e.status:($("#from_route","#comment-form").val(e.json.from_route),$("#to_route","#comment-form").val(e.json.to_route),$("#distance","#comment-form").val(e.json.distance),$("#out_dt","#comment-form").val(e.json.out_dt),$("#est_dt","#comment-form").val(e.json.est_dt))}}).done(function(){"false"!==o?(comment.dialog({buttons:{"Хадгалах":function(){$("p.feedback",comment).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var t={};$("textarea",comment).each(function(){var e=$(this);t[e.attr("name")]=e.val()}),t.route_id=e,$.ajax({type:"POST",url:base_url+"/trip/index/comment/",data:t,dataType:"json",success:function(e){"success"==e.status?(comment.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",comment).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){comment.dialog("close")}}}),comment.dialog("open")):alert("Өмнөх чиглэлд эхлээд тэмдэглэл хийнэ үү!")})}function edit_spot_dialog(e,t){var o={id:e,parent_id:t};$.ajax({type:"POST",url:base_url+"/trip/index/get_route/",data:o,dataType:"json",success:function(e){status=e.status,"true"==status&&(is_come=e.json.is_come,out_dt=e.json.out_dt,$("#from_route",edit_spot).val(e.json.from_route),$("#to_route",edit_spot).val(e.json.to_route),$("#distance",edit_spot).val(e.json.distance),$("#out_dt_edit",edit_spot).val(e.json.out_dt),"Y"!==is_come?($,$("#wrap_est_dt").hide()):$("#est_dt_edit",edit_spot).val(e.json.est_dt),gen_option(e,"#edit-spot"),$("#comment",edit_spot).val(e.json.comment),$("#employee_id",edit_spot).val(e.json.infoby_id))}}).done(function(){edit_spot.dialog({buttons:{"Хадгалах":function(){$("p.feedback",edit_spot).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var o={};$('input[type="text"], input[type="hidden"], select, textarea',edit_spot).each(function(){var e=$(this);o[e.attr("name")]=e.val()}),o.route_id=e,o.parent_id=t,$.ajax({type:"POST",url:base_url+"/trip/index/update_route_by/",data:o,dataType:"json",success:function(e){"success"==e.status?(edit_spot.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",edit_spot).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){$("#wrap_est_dt").show(),edit_spot.dialog("close")}}}),out_dt?edit_spot.dialog("open"):alert("Энэ чиглэлд явсан хугацаа оруулаагүй тул засах боломжгүй!")})}function reload(){jQuery("#grid").jqGrid("setGridParam",{datatype:"json"}).trigger("reloadGrid")}function set_route(e){var t=[];"create"==e?$("input[class='route']","#create-form").each(function(){$(this).val()&&t.push({route_id:$(this).val()})}):$("input[class='route']","#edit-form").each(function(){$(this).val()&&t.push({route_id:$(this).val()})}),console.log("routes"+t);return JSON.stringify(t)}function count_array(e,t){for(var o=0,a=0;a<e.length;a++)e[a]===t&&o++;return o}function current_date(){var e=new Date,t=e.getDate(),o=e.getMonth()+1,a=e.getFullYear(),s=addZero(e.getHours()),i=addZero(e.getMinutes()),n=addZero(e.getSeconds());return t<10&&(t="0"+t),o<10&&(o="0"+o),a+"-"+o+"-"+t+" "+s+":"+i+":"+n}function addZero(e){return e<10&&(e="0"+e),e}function check_hours(e){var t=new Date(current_date()),e=new Date(e),o=(o=Math.abs(t-e)/1e3)/60;return o/=60}function gen_option(e,t){var o=$("#employee_id",t);if(o.prop)a=o.prop("options");else var a=o.attr("options");$("option",o).remove(),o.append(new Option("ИТА-с сонго!",0)),$.each(e.dtl,function(e,t){a[a.length]=new Option(t.employee,t.employee_id)})}function showMessage(e,t){$("p#notification").length||$("#nav-bar").prepend('<p id="notification"></p>');var o=$("p#notification");o.hide(),o.removeClass(),o.addClass(t),o.html(e),o.fadeIn("fast",function(){o.delay(3e3).fadeOut()})}var edit,go,come,edit_spot;$(document).ready(function(){$(".chosen-select").chosen(),$("#trip").tagit({availableTags:["Улаанбаатар"]}),$("#location","#create-form").change(function(){var e=$(this).find("option:selected"),t=[];$("input[class=route]","#create-form").each(function(){t.push($(this).val())});count_array(t,"21")>1?alert("Маршрутыг зөв оруулсан тул дахин эцсийн цэгийг нэмэх шаардлаггүй!, Эцсийн цэгийг устгаад нэмэх боломжтой!"):($("#wrapper-tag","#create-form").append("<span class ='btn-tag' id='"+e.val()+"'>"+$(this).find("option:selected").text()+" <a class='close-tag'><span class='text-icon'>×</span></a></span>"),$("#create-form").append("<input type='hidden' name='route_id[]' class='route' value='"+e.val()+"'>"),"Улаанбаатар"!=$(this).find("option:selected").text()&&$("#wrapper-tag","#create-form").append("<span>-></span>"))}),$("#location","#edit-form").change(function(){var e=$(this).find("option:selected"),t=[];$("input[class=route]","#edit-form").each(function(){t.push($(this).val())});count_array(t,"21")>1?alert("Эхний цэгийг дахин оруулсан тул маршрутыг зөв оруулсан тул дахин байршил нэмэх шаардлаггүй!"):($("#wrapper-tag","#edit-form").append("<span class ='btn-tag' id='"+e.val()+"'>"+$(this).find("option:selected").text()+" <a class='close-tag'><span class='text-icon'>×</span></a></span>"),$("#edit-form").append("<input type='hidden' name='route_id[]' class='route' value='"+e.val()+"'>"),"Улаанбаатар"!=$(this).find("option:selected").text()&&$("#wrapper-tag","#edit-form").append("<span>-></span>"))}),jqgrid(),$("#start_dt").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),$("#start_dt_edit","#edit-form").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0}),$("#end_dt").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0}),$("#end_dt_edit").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0}),$("#action_dt").datetimepicker({opened:!1,dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0}),$(".available").css("width","240px"),$(".selected").css("width","200px"),comment=$("#comment-form"),comment.dialog({autoOpen:!1,width:570,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',comment).val(""),$(this).dialog("close")}}),(edit=$("#edit-form")).dialog({autoOpen:!1,width:570,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',edit).val(""),$(".multiselect",edit).multiselect("destroy"),$("#wrapper-tag",edit).empty(),$(".route",edit).remove(),$(this).dialog("close")}}),spot=$("#in-form"),spot.dialog({autoOpen:!1,width:570,height:340,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',spot).val(""),$(this).dialog("close")}}),(go=$("#go-form")).dialog({autoOpen:!1,width:520,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',go).val(""),$(".multiselect",go).multiselect("destroy"),$(this).dialog("close")}}),(edit_spot=$("#edit-spot")).dialog({autoOpen:!1,width:570,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',edit_spot).val(""),$(this).dialog("close")}}),$("#section_id","#create-form").change(function(){var e=$(this).val();console.log("section_id"+e);var t=$('input[name="csrf_hash_name"]',"#create-form").val();$.post(base_url+"/trip/index/filter",{id:e,csrf_hash_name:t},function(e){var t=$("#employee_id","#create-form");if(t.prop)o=t.prop("options");else var o=t.attr("options");$("option",t).remove(),$.each(e,function(e,t){o[o.length]=new Option(t,e)})}).done(function(){$(".multiselect","#create-form").multiselect("destroy"),$(".multiselect","#create-form").multiselect({minWidth:"400px"}),$(".available").css("width","240px"),$(".selected").css("width","200px")})}),$("#section_id",edit).change(function(){var e=$(this).val(),t=$('input[name="csrf_hash_name"]',edit).val();$.post(base_url+"/trip/index/filter",{id:e,csrf_hash_name:t},function(e){var t=$("#employee_id_edit",edit);if(t.prop)o=t.prop("options");else var o=t.attr("options");$("option",t).remove(),$.each(e,function(e,t){o[o.length]=new Option(t,e)})}).done(function(){$(".multiselect",edit).multiselect("destroy"),$(".multiselect",edit).multiselect(),$(".available").css("width","240px"),$(".selected").css("width","200px")})});var e;e=$("#create-form").dialog({autoOpen:!1,height:"auto",width:580,modal:!0,buttons:{"Хадгалах":function(){var t={};$('input[type="text"], input[type="hidden"], select, textarea',"#create-form").each(function(){var e=$(this);t[e.attr("name")]=e.val()}),t.routes=set_route("create"),$.ajax({type:"POST",url:base_url+"/trip/index/add/",data:t,dataType:"json",async:!1,success:function(t){"success"==t.status?(e.dialog("close"),showMessage(t.message,"success"),reload()):$("p.feedback","#create-form").removeClass("success, notify").addClass("error").html(t.message).show()}})},"Хаах":function(){e.dialog("close")}},close:function(){$(".multiselect",e).multiselect("destroy"),$(".route",e).remove(),$(this).dialog("close")}}),$("#create_trip").on("click",function(){$("#wrapper-tag","#create-form").append("<span class='btn-tag' id='tag_21'>Улаанбаатар </span><span>-></span>"),$("#create-form").append("<input type='hidden' name='route_id[]' id='route_id' class='route' value='21'> "),e.dialog("open")}),$(".close-tag",edit).live("click",function(){var e=$(this).parent().attr("id");$(this).parent().next().remove(),$(this).parent().remove(),21==e?$("input[value="+e+"][class='route']",edit).last().remove():$("input[value="+e+"][class='route']",edit).remove()}),$(".close-tag","#create-form").live("click",function(){var e=$(this).parent().attr("id");$(this).parent().next().remove(),$(this).parent().remove(),$("input[value="+e+"]","#create-form").remove()})});