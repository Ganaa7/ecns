function feeds(e,t){$("p.feedback",file).hasClass("error")&&$("p.feedback",file).removeClass("error"),$("p.feedback",file).hasClass("success")&&$("p.feedback",file).removeClass("success"),$("p.feedback",file).addClass(e).html(t).show(),$("p.feedback",file).stop().fadeIn("fast",function(){$("p.feedback",file).delay(5e3).fadeOut()})}function filter_post(e,t,i,o){var a=$("#section_id",e).val();$.post(base_url+"/flog/index/input_jx",{id:t,field:i,cat_id:a,table:o},function(t){var i=$("#"+o+"_id",e);if(i.prop)var a=i.prop("options");else a=i.attr("options");$("option",i).remove(),$.each(t,function(e,t){a[a.length]=new Option(t,e)});var s=$("#"+o+"_id option",e);s.sort(function(e,t){return e.text>t.text?1:e.text<t.text?-1:0}),$("#"+o+"_id",e).empty().append(s).prop("selected",!0)})}function filter_front(e,t,i,o){$.post(base_url+"/flog/index/jx_front_filter",{id:t,field:i,table:o},function(t){var i=$("#"+o+"_id",e);if(i.prop)var a=i.prop("options");else a=i.attr("options");$("option",i).remove(),$.each(t,function(e,t){a[a.length]=new Option(t,e)})})}function filter_event(e){$("#section_id",e).change(function(){var t=$(this).val();filter_front(e,t,"section_id","sector"),filter_front(e,t,"section_id","equipment")}),$("#sector_id",e).change(function(){var t=$(this).val();$("#section_id option[value="+~~(t/10)+"]",e).attr("selected","selected"),filter_front(e,t,"sector_id","equipment")}),$("#location_id",e).change(function(){var t=$(this).val();filter_post(e,t,"equipment_id","vw_loc_equip")})}function set_select(){var e="",t=0;return $("#section_id option").each(function(){e=$(this).text()+":"+$(this).text(),t++}),console.log("count"+t),e=":Бүгд;Холбоо:Холбоо;Навигаци:Навигаци;Ажиглалт:Ажиглалт;Гэрэл суулт, цахилгаан:ГСЦ;ЧОУНБ (NUBIA):ЧОУНБ(NUBIA)",e}function filter_equipment(e,t,i,o){var a=$("#section_id",e).val();$.post(base_url+"/flog/index/input_jx",{id:t,field:i,cat_id:a,table:o},function(t){var i=$("#"+o+"_id");if(i.prop)var a=i.prop("options");else a=i.attr("options");$("option",i).remove(),$.each(t,function(e,t){a[a.length]=new Option(t,e)});var s=$("#"+o+"_id option",e);s.sort(function(e,t){return e.text>t.text?1:e.text<t.text?-1:0}),$("#"+o+"_id",e).empty().append(s).prop("selected",!0)})}function filter_location(e){$("#location_id",e).change(function(){var t=$(this).val();filter_equipment(e,t,"equipment_id","vw_loc_equip")})}function reset(e){$.ajax({type:"POST",url:base_url+"/ftree/jx_reset/",data:{equipment_id:e},dataType:"json",success:function(t){"success"==t.status?console.log("reset success "+e):console.log("reset: failed "+e)}})}function jqgrid(){$("#grid").jqGrid({url:base_url+"/flog/index/grid",datatype:"xml",mtype:"GET",colNames:["Зэрэглэл","Гэмтэл №","Хэсэг","Нээсэн / t","Байршил","Төхөөрөмж","Төрөл","Гэмсэн модуль, дэд хэсэг","Хаасан / t","Үргэлж/цаг","Шалтгаан","Гүйцэтгэл","Үйлдэл","Closed","equipment_id"],colModel:[{name:"q_level",index:"q_level",width:25,align:"center"},{name:"log_num",index:"log_num",width:50,align:"center"},{name:"section",index:"section",width:80,stype:"select"},{name:"created_dt",index:"created_dt",width:80,searchoptions:{sopt:["eq","ne","le","lt","gt","ge"],dataInit:function(e){$(e).datepicker({dateFormat:"yy-mm-dd"}).change(function(){$("#grid")[0].triggerToolbar()})}}},{name:"location",index:"location",width:60,align:"center",formatter:view_link},{name:"equipment",index:"equipment",width:90,search:!1},{name:"log_type",index:"log_type",width:70,formatter:view_link},{name:"node",index:"node",width:120,align:"left",formatter:view_link,searchoptions:{sopt:["eq","bw","bn","cn","nc","ew","en"]}},{name:"closed_dt",index:"closed_dt",width:80,align:"right",searchoptions:{sopt:["eq","ne","le","lt","gt","ge"],dataInit:function(e){$(e).datepicker({dateFormat:"yy-mm-dd"}).change(function(){$("#grid")[0].triggerToolbar()})}}},{name:"duration",index:"duration",width:50,align:"center"},{name:"reason",index:"reason",width:90,sortable:!0,align:"center"},{name:"completion",index:"completion",width:90,sortable:!0,align:"center"},{name:"act",index:"act",width:110,align:"center",sortable:!1,formatter:log_action},{name:"status",index:"status",hidden:!0,viewable:!0},{name:"equipment_id",hidden:!0,viewable:!0}],pager:"#pager",rowNum:20,rowList:[10,20,30,40],sortname:"log_id",sortorder:"desc",viewrecords:!0,gridview:!0,caption:"Гэмтэл дутагдал",autowidth:!0,height:500,width:"100%",editurl:"server.php",loadComplete:function(){for(var e=$(this).jqGrid("getDataIDs"),t=0;t<e.length;t++){var i=$("#grid").jqGrid("getRowData",e[t]),o=jQuery("#"+e[t],jQuery("#grid"));switch(i.status){case"C":o.removeClass("ui-widget-content"),o.addClass("warning");break;case"A":o.removeClass("ui-widget-content"),o.addClass("argent");break;case"N":o.removeClass("ui-widget-content"),o.addClass("warning");break;case"Q":o.removeClass("ui-widget-content"),o.addClass("qualify");break;case"F":o.removeClass("ui-widget-content"),o.addClass("file")}}}}).navGrid("#pager",{edit:!1,add:!1,del:!1,search:!0}),jQuery("#grid").jqGrid("filterToolbar",{searchOperators:!0,stringResult:!0,defaultSearch:"cn"})}function view_link(e,t){return"<a href='#' onclick='init_view("+t.rowId+")' >"+e+"</a>"}function log_action(e,t,i){action_str="<div title='Дэлгэрэнгүй' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><span id='log_none' onclick='init_view("+t.rowId+")' class='ui-icon ui-icon-extlink'></span></div></div>";$("#action").serializeArray();return $("input.action").each(function(){switch($(this).val()){case"activate":action_str=action_str+"<div title='Зөвшөөрөл өгөх' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><span id='log_approve' onclick='initApprove("+t.rowId+")' class='ui-icon ui-icon-unlocked'></span></div>";break;case"close":action_str=action_str+"<div title='Хаах' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><span onclick='init_close("+t.rowId+")' class='ui-icon ui-icon-wrench'></span></div></div>";break;case"edit":action_str=action_str+"<div style='margin-left:8px;'><div title='Засах' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><a href="+base_url+"/flog/index/edit/"+t.rowId+"><span class='ui-icon ui-icon-pencil'></span></a></div>";break;case"delete":action_str=action_str+"<div title='Устгах' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><span onclick='_delete("+t.rowId+")' target ="+t.log_num+" class='ui-icon ui-icon-trash'></span></div></div>";break;case"quality":action_str=action_str+"<div title='Эрсдэл үнэлэх' style='float:left;cursor:pointer;' class='ui-pg-div'><span onclick='init_quality("+t.rowId+")' target ="+t.log_num+" class='ui-icon  ui-icon-check'></span></div></div>";break;case"file":action_str=action_str+"<div title='Тайлангийн файл хавсаргах' style='float:left;cursor:pointer;'><span onclick='init_file("+t.rowId+")' target ="+t.log_num+" class='ui-icon  ui-icon ui-icon-link'></span></div></div>";break;case"show_ftree":action_str=action_str+"<div title='Алдааны мод харах' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><span onclick='_ftree("+t.rowId+")' target ="+t.log_num+" class='ui-icon  ui-icon-alert'></span></div></div>";break;case"attach":action_str=action_str+"<div title='Файл шаардлагатай' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit'><span onclick='attach("+t.rowId+")' class='ui-icon  ui-icon-tag'></span></div></div>"}}),action_str}function initApprove(e){var t,i={id:e};$.ajax({type:"POST",url:base_url+"/flog/index/catch/",data:i,dataType:"json",success:function(e){$("#log_id",approve).val(e.log.log_id),$("#status",approve).val(e.log.status),$("#log_num",approve).val(e.log.log_num),$("#category",approve).text(e.log.section),$("#equipment_id",approve).val(e.log.equipment_id),null===e.log.log_num?$("#log_num_txt",approve).text("Зөвшөөрөх дарахад автоматаар олгогдоно."):$("#log_num_txt",approve).text(e.log.log_num),$("#section",approve).text(e.log.section),$("#created_dt",approve).text(e.log.created_dt),$("#createdby_id",approve).text(e.log.createdby),$("#location_id",approve).text(e.log.location),$("#equipment_id",approve).text(e.log.equipment),$("#log_type",approve).text(e.log.log_type),$("#node",approve).text(e.log.node),$("#reason",approve).text(e.log.reason),"Y"==e.log.status||"N"==e.log.status?($("#closed_dt",approve).text(e.log.closed_dt),$("#duration",approve).text(e.log.duration),$("#closedby_id",approve).text(e.log.closedby),$("#completion",approve).text(e.log.completion),$("#wrap_closed",approve).show()):$("#wrap_closed",approve).hide(),e.log.log_num?title='"'+e.log.log_num+'" дугаартай гэмтэл':title="Гэмтэл",t="A"==e.log.status||"Y"==e.log.status||"Q"==e.log.status||"F"==e.log.status?"activated":"activate"}}).done(function(){_call_fn(t,title)})}function approve_dialog(e){approve.dialog("option","title",e),approve.dialog({buttons:{"Зөвшөөрөх":function(){$("p.feedback",approve).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var e={},t=$('input[type="text"], input[type="hidden"], select',approve);t.each(function(){var t=$(this);e[t.attr("name")]=t.val()}),$.ajax({type:"POST",url:base_url+"/flog/index/active/",data:e,dataType:"json",success:function(e){"success"==e.status?(approve.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",approve).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){approve.dialog("close")}}}),approve.dialog("open")}function button_bind(){$("#_close").click(function(){var e=$("#grid").jqGrid("getGridParam","selrow");e?init_close(e):alert("[Хаах] гэмтлийг гэмтлийн жагсаалтаас сонгоно уу!")}),$("#_active").click(function(){var e=$("#grid").jqGrid("getGridParam","selrow");e?initApprove(e):alert("[Зөвшөөрөх] гэмтлийн жагсаалтаас гэмтлийг сонгоно уу!")}),$("#quality").click(function(){var e=$("#grid").jqGrid("getGridParam","selrow");e?init_quality(e):alert("Эрсдэл үнэлэх гэмтлийг сонгоно уу!")}),$("#_delete").click(function(){var e=$("#grid").jqGrid("getGridParam","selrow");e?_delete(e):alert("[Устгах] гэмтлийг сонгоно уу!")}),$("#_edit").click(function(){var e=$("#grid").jqGrid("getGridParam","selrow");e?init_edit(e):alert("[Засах] гэмтлийг гэмтлийн жагсаалтаас сонгоно уу! \n ")})}function init_close(e){var t,i={id:e};$.ajax({type:"POST",url:base_url+"/flog/index/catch/",data:i,dataType:"json",success:function(e){t="N"==e.log.status?"closing":"Y"==e.log.status||"Q"==e.log.status||"F"==e.log.status?"closed":"C"==e.log.status?"created":"close"}}).done(function(){_call_fn(t,title=null,e)})}function close_dialog(e){location.href=base_url+"/flog/index/close_form/"+e}function reload(){$("#grid").trigger("reloadGrid")}function _delete(e){var t,i={id:e},o=$("#grid").getRowData(e);t="-"!==o.log_num?window.confirm("Та '"+o.log_num+"' дугаартай гэмтлийг устгахдаа итгэлтэй байна уу?"):window.confirm("Та [Хаах] үйлдэл хийгдээгүй гэмтлийг устгахдаа итгэлтэй байна уу?"),t&&$.ajax({type:"POST",url:base_url+"/flog/index/delete/",data:i,dataType:"json",success:function(e){"success"==e.status&&(showMessage(e.message,"success"),reload())}})}function _ftree(e){var t=$("#grid").getRowData(e);window.location="/ftree/tree/"+t.equipment_id}function attach(e){var t,i={id:e};$.ajax({type:"POST",url:base_url+"/flog/index/catch/",data:i,dataType:"json",success:function(e){t="N"==e.log.status?"closing":"Y"==e.log.status||"Q"==e.log.status?"closed":"F"==e.log.status?"attached":"C"==e.log.status?"created":"close"}}).done(function(){"attached"==t?1==confirm("Энэ гэмтэлд аль хэдийн файл шаардлагатай үйлдлийг хийсэн байна.\n Файл шаардах үйлдлийг цуцлах уу?")&&$.ajax({type:"POST",url:base_url+"/flog/index/_cancel/",data:{id:e},dataType:"json",success:function(e){e.success?(showMessage(e.message,"success"),reload()):(showMessage(e.message,"error"),reload())}}):"created"==t||"closing"==t?alert("Гэмтлийг нээж байна! Хаасны дараа энэ үйлдэл боломжтой!"):"closed"==t&&$.ajax({type:"POST",url:base_url+"/flog/index/_attach/",data:{id:e},dataType:"json",success:function(e){"success"==e.status?(showMessage(e.message,"success"),reload()):(showMessage(e.message,"error"),reload())}})})}function cancel(e){alert("cancel loaded"+e)}function showMessage(e,t){$("p#notification").length||$("#nav-bar").prepend('<p id="notification"></p>');var i=$("p#notification");i.hide(),i.removeClass(),i.addClass(t),i.html(e),i.fadeIn("fast",function(){i.delay(3e3).fadeOut()})}function init_view(e){$(".fixing_field","#view_dialog").hide(),$("#field_closed_comment",view).hide(),$("#field_comment",view).hide();var t={id:e};$.ajax({type:"POST",url:base_url+"/flog/index/catch/",data:t,dataType:"json",success:function(e){$("#log_id",view).val(e.log.log_id),$("#log_num",view).val(e.log.log_num),$("input[name=created_datetime]",view).val(e.log.created_dt),$("#createdby_id",view).text(e.log.createdby),$("#category",view).val(e.log.section),$("#location_id option[value="+e.log.location_id+"]",view).attr("selected","selected"),$("#equipment_id option[value="+e.log.equipment_id+"]",view).attr("selected","selected"),$("#log_type_id option[value="+e.log.type_id+"]",view).attr("selected","selected"),$("#defect",view).val(e.log.node),e.log.comment&&($("#field_comment",view).show(),$("#comment",view).val(e.log.comment)),$("#reason_id option[value="+e.log.reason_id+"]",view).attr("selected","selected"),e.log.equip_com_id&&null!==e.log.equip_com_id&&($("#equip_comp",view).show(),$("#equip_com_id").text(e.log.equip_comp)),"Y"==e.log.status||"N"==e.log.status||"Q"==e.log.status||"F"==e.log.status?($("#closed_datetime",view).val(e.log.closed_dt),$("#duration",view).val(e.log.duration),$("#closedby_id",view).text(e.log.closedby),$("#completion_id option[value="+e.log.completion_id+"]",view).attr("selected","selected"),$("#wrap_closed",view).show(),$("input[name=is_spare][value="+e.log.is_spare+"]").attr("checked","checked"),"Y"==e.log.is_spare?($(".spare_fields").show(),$("#sparetype_id option[value="+e.log.sparetype_id+"]",view).attr("selected","selected"),$("#spare").val(e.log.spare)):$(".spare_fields").hide(),e.log.closed_comment&&($("#field_closed_comment",view).show(),$("#closed_comment",view).val(e.log.closed_comment))):$("#wrap_closed",view).hide(),e.log.log_num?title='"'+e.log.log_num+'" дугаартай гэмтэлийн дэлгэрэнгүй':title="Гэмтлийн дэлгэрэнгүй",e.log.filename?$("#show_file",view).html("<span>Тайлангийн файл:</span>  <span id='file_link'><a href='"+base_url+"/download/log_files/"+e.log.filename+"' download style='color:blue'>"+e.log.filename+"</a></span>"):$("#show_file",view).html("<span>Тайлангийн файл:</span>  <span id='file_link'>Файл оруулаагүй байна!</span>")}}).done(function(){view.dialog("option","title",title),view.dialog({buttons:{"Хаах":function(){view.dialog("close")}}}),view.dialog("open")})}function init_file(e){var t,i={id:e};$.ajax({type:"POST",url:base_url+"/flog/index/catch/",data:i,dataType:"json",success:function(e){"success"==e.status?($("#log_id",file).val(e.log.log_id),$("#log_num",file).text(e.log.log_num),$("#section",file).text(e.log.section),$("#created_dt",file).text(e.log.created_dt),$("#createdby_id",file).text(e.log.createdby),$("#location_id",file).text(e.log.location),$("#equipment_id",file).text(e.log.equipment),$("#node",file).text(e.log.node),$("#log_type",file).text(e.log.log_type),$("#reason",file).text(e.log.reason),"Y"==e.log.status||"Q"==e.log.status||"N"==e.log.status||"F"==e.log.status?($("#closed_dt",file).text(e.log.closed_dt),$("#duration",file).text(e.log.duration),$("#closedby_id",file).text(e.log.closedby),$("#completion",file).text(e.log.completion),$("#level",file).text(e.log.level),$("#num",file).text(e.log.num),$("#wrap_closed",file).show()):$("#wrap_closed",file).hide(),"C"==e.log.status||"Q"==e.log.status||"A"==e.log.status||"N"==e.log.status?t="nofile":"Y"==e.log.status?t="hasfile":"F"==e.log.status&&(t="file")):alert("Ямар нэг зүйл буруу учраас алдаа гарлаа!!!"),e.log.log_num?title='"'+e.log.log_num+'" дугаартай гэмтлийн эрсдэл үнэлэх':title="Гэмтлийн эрсдэл үнэлэх"}}).done(function(){console.log("STATE"+t),_call_fn(t,title)})}function init_quality(e){var t,i={id:e};$.ajax({type:"POST",url:base_url+"/flog/index/catch/",data:i,dataType:"json",success:function(e){$("#log_id",quality).val(e.log.log_id),$("#log_num",quality).text(e.log.log_num),$("#section",quality).text(e.log.section),$("#created_dt",quality).text(e.log.created_dt),$("#createdby_id",quality).text(e.log.createdby),$("#location_id",quality).text(e.log.location),$("#equipment_id",quality).text(e.log.equipment),$("#node",quality).text(e.log.node),$("#type",quality).text(e.log.log_type),$("#reason",quality).text(e.log.reason),t=e.log.qualityby_id||"Y"==e.log.status?"qualified":"Q"==e.log.status?"quality":"N"==e.log.status?"notactive":"created",$("#closed_dt",quality).text(e.log.closed_dt),$("#duration",quality).text(e.log.duration),$("#closedby_id",quality).text(e.log.closedby),$("#completion",quality).text(e.log.completion),$("#wrap_closed",quality).show(),e.log.log_num?title='"'+e.log.log_num+'" дугаартай гэмтлийн эрсдэл үнэлэх':title="Гэмтлийн эрсдэл үнэлэх"}}).done(function(){console.log("state: "+t),_call_fn(t,title)})}function _quality(e){quality.dialog("option","title",e),quality.dialog({buttons:{"Хадгалах":function(){$("p.feedback",quality).removeClass("success, error").addClass("notify").html("Утгуудыг сервер руу илгээж байна...").show();var e={},t=$('input[type="text"], input[type="hidden"], select',quality);t.each(function(){var t=$(this);e[t.attr("name")]=t.val()}),$.ajax({type:"POST",url:base_url+"/flog/index/quality/",data:e,dataType:"json",success:function(e){"success"==e.status?(quality.dialog("close"),showMessage(e.message,"success"),reload()):$("p.feedback",quality).removeClass("success, notify").addClass("error").html(e.message).show()}})},"Хаах":function(){quality.dialog("close")}}}),quality.dialog("open")}function _call_fn(e,t,i){switch(e){case"activated":alert('Аль хэдийн "Зөвшөөрөх" үйлдэл хийгдсэн тул дахиж хийх шаардлагагүй!');break;case"activate":approve_dialog(t);break;case"notactive":alert('"Ерөнхий зохицуулагч инженер" зөвшөөрөх үйлдэл хийсний дараа энэ үйлдэл боломжтой!');break;case"closing":alert("Хаах хүсэлтийг аль хэдийн илгээсэн тул энэ үйлдэл шаардлагагүй!");break;case"closed":alert("Энэ гэмтэл аль хэдийн хаагдсан тул дахиж хаах шаардлагагүй!");break;case"close":close_dialog(i);break;case"created":alert("Шинээр нээсэн гэмтэл дээр энэ үйлдэл боломжгүй!");break;case"qualified":alert("Энэ гэмтлийн эсрдлийг аль хэдийн үнэлсэн байна!");break;case"quality":_quality(t);break;case"edit":edit_dialog(t);break;case"nofile":alert("Энэ гэмтэлд файл хавсаргах боломжгүй! Эрсдлийн үнэлгээ хийгдсэний дараа тайлангийн файл хавсаргах эсэх нь шийдэгдэнэ");break;case"file":_upload(t)}}function warn_page(){var e=$("#grid").jqGrid("getGridParam","selrow"),t=$("#grid").jqGrid("getCell",e,"status");e?"C"==t||"N"==t||"A"==t?alert("Энэ гэмтэл хаагдаагүй байна, хаагдсан гэмтлийг сонгоно уу!"):window.location=base_url+"/flog/warnpage/"+e:alert("Нэг гэмтлийг сонгоно уу!")}function _upload(e){file.dialog("option","title",e),file.dialog({buttons:{"Хаах":function(){file.dialog("close"),reload()}}}),file.dialog("open")}function del_file(e,t){if(1!=confirm("["+t+"] энэ файлыг устгахдаа итгэлтэй байна уу?"))return 0;$.ajax({type:"POST",url:base_url+"/flog/index/del_file/"+e,data:{id:e,file_name:t},dataType:"json",success:function(e){e.success?(feeds("success",e.message),$("#file_link",file).remove(),$("#cert_file").show()):(feeds("error",e.message),$("#file_link",file).remove(),$("#cert_file").show())}})}var open,edit,approve,close,view,quality,role,action_str,sel_str,file,level,num,form;window.open=!1,$(document).ready(function(){$("#spare_id").on("change",function(e){$.post(base_url+"/flog/index/get_spare",{spare_id:$(this).val()},function(e){$("#part_serial").val(e.part_number),$("#part_number","#edit_form").val(e.part_number),$("#spare").val(e.spare)})}),role=$("#user_role").val(),sel_str=set_select();var e=$("#create_form"),t=$("#log_filter");if(filter_event(t),$("#start_dt").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0}),$("#end_dt").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0}),$("#section_id",t).change(function(){$('#gs_section option[value="'+$("#section_id option:selected",t).text()+'"]').attr("selected",!0)}),$("#filterBtn",t).click(function(){sessionStorage.clear(),$("#gs_q_level").val(""),$("#gs_section").val(""),$("#gs_section").val(""),$("#gs_log_num").val(""),$("#gs_created_datetime").val(""),$("#gs_location").val(""),$("#gs_equipment").val(""),$("#gs_defect").val(""),$("#gs_closed_datetime").val(""),$("#gs_duration_time").val(""),$("#gs_completion").val("");var e=$("#section_id option:selected",t).text();$('#gs_section option[value="'+e+'"]').attr("selected",!0),sessionStorage.setItem("section_id",$("#section_id option:selected",t).val());var i={},o=$('input[type="text"], input[type="hidden"], select',t);o.each(function(){var e=$(this);i[e.attr("name")]=e.val()}),(i.start_dt||i.end_dt)&&"0"==i.date_option?(alert("Огнооны төрлийг сонгоно уу!"),$("#date_option").focus()):jQuery("#grid").jqGrid("setGridParam",{url:base_url+"/flog/index/grid",page:1,search:!1,postData:{filters:"",filterBtn:!0,section_id:i.section_id,sector_id:i.sector_id,equipment_id:i.equipment_id,log:i.log,date_option:i.date_option,start_dt:i.start_dt,end_dt:i.end_dt}}).trigger("reloadGrid")}),sessionStorage.getItem("created_dt")){var i=sessionStorage.getItem("created_dt");$("#created_dt",e).val(i),sessionStorage.clear()}$(document).tooltip(),$("#created_dt",e).datetimepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),$("#reason_log_1",e).hide(),$("#reason_log_2",e).hide(),filter_location(e);$("#location_id",e);if($("#section_id",e).change(function(){sec_id=$("#section_id option:selected",e).val(),$.post(base_url+"/flog/index/filter_sec",{section_id:sec_id},function(t){var i=$("#location_id",e);if(i.prop)var o=i.prop("options");else o=i.attr("options");$("option",i).remove(),$("option","#vw_loc_equip_id").remove(),$.each(t,function(e,t){o[o.length]=new Option(t,e)});var a=$("#location_id option",e);a.sort(function(e,t){return e.text>t.text?1:e.text<t.text?-1:0}),$("#location_id",e).empty().append(a).prop("selected",!0)})}),$("#vw_loc_equip_id",e).change(function(){equipment_id=$("#vw_loc_equip_id option:selected",e).val(),created_dt=$("#created_dt",e).val();var t=$("#section_id",e).val(),i=$("#location_id",e).val();sessionStorage.setItem("created_dt",created_dt),sessionStorage.setItem("change_form_flag","false"),location.href=base_url+"/flog/index/create_form/?equipment_id="+equipment_id+"&section_id="+t+"&location_id="+i+"&selected=y"}),$(".overflow").length){var o=$("#vw_loc_equip_id option:selected").text();$(".tree").length||$(".overflow").append('<p class="error">Алдааны мод олдсонгүй! ['+o+"] төхөөөрөмж дээр Алдааны мод үүсгээгүй байна! \n Тухайн тоног төхөөрөмж хариуцсан системийн инженерт мэдэгдэнэ үү! ")}$("#btn_save",e).click(function(){var t={},i=[],o=$('input[type="text"], input[type="hidden"], select, textarea',"#create_form");$("input[class=node]").each(function(){i.push({node_id:$(this).val()})});var a=JSON.stringify(i);o.each(function(){var e=$(this);t[e.attr("name")]=e.val()}),reset(t.equipment_id),t.nodes=a,$.ajax({type:"POST",url:base_url+"/flog/index/add/",data:t,dataType:"json",async:!1,success:function(t){"success"==t.status?(showMessage(t.message,"success"),location.href=base_url+"/flog/index"):($("#container").animate({scrollTop:0},400),$("p.feedback",e).removeClass("success, notify").addClass("error").html(t.message).show())}})}),$("#reason_id",e).change(function(){var t=$("#reason_id option:selected",e).val(),i=$("#reason_id option:selected",e).text();switch(t){case"6":$("#reason_log_1",e).is(":visible")&&$("#reason_log_1",e).hide(),$("#reason_log_2",e).show();var o=$("#location_id",e).val();$.post(base_url+"/flog/index/jx_fequip",{location_id:o},function(e){var t=$("#equip_com_id");if(t.prop)var i=t.prop("options");else i=t.attr("options");$("option",t).remove(),$.each(e,function(e,t){i[i.length]=new Option(t,e)})}),$("#is_reason").val(6);break;case"5":$("#reason_log_2",e).is(":visible")&&$("#reason_log_2",e).hide();var a=$("#created_dt",e).val();o=$("#location_id",e).val();a&&o?($("#reason_log_1",e).show(),$.post(base_url+"/flog/index/jx_reason",{location_id:o,created_dt:a,action:"create",id:0},function(e){var t=$("#parent_id");if(t.prop)t.prop("options");else t.attr("options");$("option",t).remove(),$.each(e,function(e,t){$("#parent_id").append("<option value='"+e+"'>"+t+"</option>"),$("#parent_id").trigger("chosen:updated")})}),$("#is_reason").val(5)):(alert("Гэмтэл нээсэн цаг болон Байршлийг сонгох ёстой!"),$("#reason_id option").prop("selected",!1));break;default:$("#reason_log_2",e).is(":visible")&&$("#reason_log_2",e).hide(),$("#reason_log_1",e).is(":visible")&&$("#reason_log_1",e).hide(),$("#is_reason",e).val(0)}$("#reason_title").text(i)}),$("#comment_field",e).hide(),$("#set_comment",e).click(function(){$("#trigger_comment",e).hide(),$("#comment_field",e).show()}),f_close=$("#close_form"),$("#closed_dt",f_close).datetimepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1});var a=$("#reason_id",f_close),s=$("#reason_log_2",f_close),l=$("#reason_log_1",f_close);s.hide(),l.hide();var n=$("#location_id",f_close).val();switch(a.val()){case"5":s.is(":visible")&&s.hide(),l.show();break;case"6":l.is(":visible")&&l.hide(),s.show();break;default:s.is(":visible")&&s.hide()}a.change(function(){switch(a.val()){case"5":s.is(":visible")&&s.hide();var e=$("#created_dt",f_close).val(),t=$("input[name='log_id']",f_close).val();e&&n?(l.show(),$.post(base_url+"/flog/index/jx_reason",{location_id:n,created_dt:e,action:"close",id:t},function(e){var t=$("#parent_id",f_close);if(t.prop)t.prop("options");else t.attr("options");$("option",t).remove(),$.each(e,function(e,t){$("#parent_id",f_close).append("<option value='"+e+"'>"+t+"</option>"),$("#parent_id",f_close).trigger("chosen:updated")})})):(alert("Гэмтэл нээсэн цаг болон Байршлийг сонгох ёстой!"),$("#reason_id option",f_close).prop("selected",!1));break;case"6":f.is(":visible")&&f.hide(),u.show(),$.post(base_url+"/flog/index/jx_fequip",{location_id:g},function(e){var t=$("#equip_com_id",f_close);if(t.prop)var i=t.prop("options");else i=t.attr("options");$("option",t).remove(),$.each(e,function(e,t){i[i.length]=new Option(t,e)})});break;default:l.is(":visible")&&l.hide(),s.is(":visible")&&s.hide()}});var d=$(".fixing_field",f_close);d.hide(),$("#completion_id",f_close).change(function(){switch($(this).val()){case"7":$(".spare_fields",f_close).show();break;default:$(".spare_fields",f_close).is(":visible")&&$(".spare_fields",f_close).hide()}}),$(".spare_fields",f_close).hide();var c=$("#is_spare",f_close);c.change(function(){var e=$("#is_spare:checked",f_close).val();"Y"==e?$(".spare_fields",f_close).show():$(".spare_fields",f_close).is(":visible")&&$(".spare_fields",f_close).hide()}),$("#btn_save",f_close).click(function(){var e={},t=[],i=$('input[type="text"], input[type="hidden"],input[type="radio"]:checked, select, textarea',f_close);$("input[class=node]").each(function(){t.push({node_id:$(this).val()})});var o=JSON.stringify(t);i.each(function(){var t=$(this);e[t.attr("name")]=t.val()}),e.closed_dt>e.created_dt?e.duration=1:e.duration=0,e.nodes=o,$.ajax({type:"POST",url:base_url+"/flog/index/close/",data:e,dataType:"json",success:function(e){"success"==e.status?(showMessage(e.message,"success"),location.href=base_url+"/flog/index"):($("p.feedback",f_close).removeClass("success, notify").addClass("error").html(e.message).show(),$("#container").animate({scrollTop:0},400))}})}),edit=$("#edit_dialog"),approve=$("#approve_dialog"),approve.dialog({autoOpen:!1,width:570,resizable:!1,modal:!0,close:function(){$("p.feedback",approve).removeClass("error").html("").hide(),$('input[type="text"], input[type="hidden"], select',approve).val(""),$(this).dialog("close")}}),view=$("#view_dialog"),$("#equip_comp",view).hide(),"none"!==$("#equp_comp",view).css("display")&&$("#equip_comp",view).hide(),view.dialog({autoOpen:!1,width:580,resizable:!1,modal:!0,close:function(){"none"!==$("#equp_comp",view).css("display")&&$("#equip_comp",view).hide(),$("#equip_com_id",view).text(""),$('input[type="text"], input[type="hidden"], select, radio, textarea',view).val(""),$(this).dialog("close")}}),file=$("#file_dialog"),file.dialog({autoOpen:!1,width:570,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',$(this)).val(""),$("#file_link",file).empty(),$("#cert_file",file).css("display","none")&&$("#cert_file",file).show(),$(this).dialog("close")}}),quality=$("#quality_dialog"),quality.dialog({autoOpen:!1,width:570,resizable:!1,modal:!0,close:function(){$("p.feedback",$(this)).html("").hide(),$('input[type="text"], input[type="hidden"], select, textarea',$(this)).val(""),$("#wp_require").hide(),$(this).dialog("close")}}),$("#wp_require").hide(),$("#level",quality).change(function(){if(level=$(this).val(),num){var e=num+$(this).val(),t=["5C","4C","3C","5D","4D","3D","2D","1D","5E","4E","3E","2E","1E"];console.log("hi its show the file asking "+e),$.inArray(e,t)>-1?$("#wp_require").show():$("#wp_require").hide()}}),$("#num",quality).change(function(){if(num=$(this).val(),level){var e=$(this).val()+level,t=["5C","4C","3C","5D","4D","3D","2D","1D","5E","4E","3E","2E","1E"];$.inArray(e,t)>-1?$("#wp_require").show():$("#wp_require").hide()}}),$("#main_wrap").length&&jqgrid(),button_bind(),$("#show").on("click",function(){$("#open_dialog").dialog("open")}),$("#c_closed_dt").datetimepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),$(".spare_fields",view).hide();$("#id").val();var r=1;$(".module").each(function(e){module=$(this),module_id=$(this).attr("id"),1==r&&(console.log("callded: module"),r=0),$(".node").each(function(e){module_id==$(this).val()&&module.addClass("failure")})});var p=$("#edit_form");if(sessionStorage.getItem("created_dt")){i=sessionStorage.getItem("created_dt");$("#created_dt",p).val(i),sessionStorage.clear()}$(document).tooltip(),$("#section_id",p).change(function(){sec_id=$("#section_id option:selected",p).val(),$.post(base_url+"/flog/index/filter_sec",{section_id:sec_id},function(e){var t=$("#location_id",p);if(t.prop)var i=t.prop("options");else i=t.attr("options");$("option",t).remove(),$("option","#vw_loc_equip_id").remove(),$.each(e,function(e,t){i[i.length]=new Option(t,e)})})}),$("#location_id",p).change(function(){var e=$(this).val();filter_post(p,e,"equipment_id","vw_loc_equip")}),$("#created_dt",p).datetimepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),$("#closed_dt",p).datetimepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showOtherMonths:!0,showWeek:!0,opened:!1}),$("#vw_loc_equip_id",p).change(function(){equipment_id=$("#vw_loc_equip_id option:selected",p).val(),created_dt=$("#created_dt",p).val();$("#type_id",p).val(),$("#location_id",p).val(),$("#id",p).val();sessionStorage.setItem("created_dt",created_dt),$("#edit_form").submit()}),$("#type_id",p).change(function(){type_id=$("#type_id option:selected",p).val(),$.post(base_url+"/flog/index/filter_sec",{section_id:type_id},function(e){var t=$("#location_id",p);if(t.prop)var i=t.prop("options");else i=t.attr("options");$("option",t).remove(),$("option","#vw_loc_equip_id",p).remove(),$.each(e,function(e,t){i[i.length]=new Option(t,e)})})}),$("#btn_save",p).click(function(){var e={},t=[],i=$('input[type="text"], input[type="hidden"], select, input[type="radio"]:checked, textarea',"#edit_form");$("input[class=node]",p).each(function(){t.push({node_id:$(this).val()})});var o=JSON.stringify(t);i.each(function(){var t=$(this);e[t.attr("name")]=t.val()}),
e.closed_dt>e.created_dt?e.duration=1:e.duration=0,e.nodes=o,$.ajax({type:"POST",url:base_url+"/flog/index/update/",data:e,dataType:"json",success:function(e){"success"==e.status?(showMessage(e.message,"success"),location.href=base_url+"/flog/index"):(window.scrollTo(0,100),$("p.feedback",p).removeClass("success, notify").addClass("error").html(e.message).show())}})});var _=$("#reason_id",p),u=$("#reason_log_2"),f=$("#reason_log_1");u.hide(),f.hide();var g=$("#location_id",p).val();switch(_.val()){case"5":u.is(":visible")&&u.hide(),f.show();break;case"6":f.is(":visible")&&f.hide(),u.show();break;default:u.is(":visible")&&u.hide()}_.change(function(){switch(_.val()){case"5":u.is(":visible")&&u.hide();var e=$("#created_dt",p).val(),t=$("#id",p).val();e&&g?(f.show(),$.post(base_url+"/flog/index/jx_reason",{location_id:g,created_dt:e,action:"edit",id:t},function(e){var t=$("#parent_id",p);if(t.prop)t.prop("options");else t.attr("options");$("option",t).remove(),$.each(e,function(e,t){$("#parent_id",p).append("<option value='"+e+"'>"+t+"</option>"),$("#parent_id",p).trigger("chosen:updated")})})):(alert("Гэмтэл нээсэн цаг болон Байршлийг сонгох ёстой!"),$("#reason_id option",p).prop("selected",!1));break;case"6":f.is(":visible")&&f.hide(),u.show(),$.post(base_url+"/flog/index/jx_fequip",{location_id:g},function(e){var t=$("#equip_com_id",p);if(t.prop)var i=t.prop("options");else i=t.attr("options");$("option",t).remove(),$.each(e,function(e,t){i[i.length]=new Option(t,e)})});break;default:f.is(":visible")&&f.hide(),u.is(":visible")&&u.hide()}});var v=$("#status",p).val(),h=$("#completion_id",p);"C"!=v&&"A"!=v||$("#wrap_closed",p).hide();var m=$("#spare_radio",p),w=$(".fixing_field",p);7==h.val()?(w.show(),$(".spare_fields",p).show()):(w.hide(),$(".spare_fields",p).hide()),$("#completion_id",p).change(function(){switch($(this).val()){case"7":w.show(),$(".spare_fields",p).show(),$("#spare_id").val(0),$("#spare_id").trigger("chosen:updated"),$("#sparetype_id").val(0),$("#part_number").val(0),$("#qty").val(0);break;default:$('input[type="radio"][value="N"]',p).attr("checked","checked"),$(".spare_fields",p).hide(),w.hide(),$(".spare_fields",p).hide()}}),m.change(function(){"Y"==$("#is_spare:checked",p).val()?$(".spare_fields",p).show():($(".spare_fields",p).is(":visible")&&$(".spare_fields",p).hide(),$("#sparetype_id").val(0),$("#spare").val(null))}),$("#category_id",p).change(function(){cat_id=$("#category_id option:selected",p).val(),$.post(base_url+"/flog/index/filter_sec",{category_id:cat_id},function(e){var t=$("#location_id",p);if(t.prop)var i=t.prop("options");else i=t.attr("options");$("option",t).remove(),$("option","#vw_loc_equip_id",p).remove(),$.each(e,function(e,t){i[i.length]=new Option(t,e)})})}),$("#cert_file",file).change(function(){var e=new FormData($("#file_dialog")[0]);$.ajax({url:base_url+"/flog/index/upload/",type:"POST",data:e,processData:!1,contentType:!1,success:function(e){"success"==e.status?(feeds("success",e.name+" нэртэй файлыг амжилттай байршууллаа!"),e.name&&($("input[type='file",file).val("").hide(),$("#_file",file).lenght||$("#_file",file).append("<span id='file_link'><a href='"+base_url+"/download/log_files/"+e.name+"' download style='color:blue'>"+e.name+"</a> (<a href='#' style='color:red' onclick='del_file("+e.log_id+', "'+e.name+"\")'>Устгах</a>)</span>"))):(feeds("error",e.message),$("input[type='file",file).val(""))}})})});